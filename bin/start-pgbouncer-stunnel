#!/usr/bin/env bash
# Adapted from https://github.com/ryandotsmith/nginx-buildpack/

#Generate config files
echo 'buildpack=pgbouncer at=config-gen-start'
source bin/gen-pgbouncer-conf.sh
echo 'buildpack=pgbouncer at=config-gen-end'

#Overwrite config vars with pgbouncer targets
POSTGRES_URLS=${PGBOUNCER_URLS:-DATABASE_URL}

for POSTGRES_URL in $POSTGRES_URLS
do
  echo "Overriding ${POSTGRES_URL} config var"
  eval ${POSTGRES_URL}=\$${POSTGRES_URL}_PGBOUNCER
done

#Start stunnel
(
	#We expect stunnel to run in the foreground.
	echo 'buildpack=pgbouncer at=stunnel-start'
	vendor/stunnel/bin/stunnel vendor/stunnel/stunnel-pgbouncer.conf
) &

#Start PGBouncer
(
	#We expect pgbouncer to run in the foreground.
	echo 'buildpack=pgbouncer at=pgbouncer-start'
	vendor/pgbouncer/bin/pgbouncer vendor/pgbouncer/pgbouncer.ini
) &

#Start App Server
(
	#Take the command passed to this bin and start it.
	#E.g. bin/start-pgbouncer-stunnel bundle exec unicorn -c config/unicorn.rb
	echo "buildpack=pgbouncer at=app-start cmd=$*"
	"$@"
	echo 'app' >$psmgr
)
